env {
    parallelism = 1
    job.mode = "STREAMING"
    checkpoint.interval = 6000 
    read_limit.bytes_per_second=7000000
    read_limit.rows_per_second=400  
}

source {
    MongoDB-CDC {
        plugin_output = "mongocdc"
        hosts = "ac-x5cefsk-shard-00-00.mxwh0xc.mongodb.net:27017,ac-x5cefsk-shard-00-01.mxwh0xc.mongodb.net:27017,ac-x5cefsk-shard-00-02.mxwh0xc.mongodb.net:27017"
        username = "uniquemj"
        password = "hello123"
        connection.options = "replicaSet=atlas-13prxe-shard-0&authSource=admin&tls=true&retryWrites=true&w=majority&appName=ChangeStream"

        database = ["playground"]
        collection = ["playground.tasks"]

        schema = {

            # This is for field mapping of tasks collection
            tables = "playground.tasks"
            columns = [
                {
                    name = _id
                    type = "string"
                    columnLength = 255
                    nullable = false
                },
                {
                    name = ordinal
                    type = "int"
                },
                {
                    name = added_by
                    type = "string"
                },
                {
                    name = title
                    type = "string"
                },
                {
                    name = description
                    type = "string"
                },
                {
                    name = status
                    type ="string"
                },
                {
                    name = due_date
                    type = "timestamp"
                },
                {
                    name = created_at
                    type = "timestamp"
                }
            ]
            primaryKey {
                name = "_id"
                columnNames = [_id]
            }


            # This is require for transform to work as transform is currently configure for this only.
            # columns = [
            #     {
            #         name = _id
            #         type = "string"
            #         nullable = false
            #         columnLength = 255
            #     },
            #     {
            #         name = value
            #         type = "string"
            #     }
            # ]
        }

        # Uncomment to Enable startup mode as TimeStamp
        # startup.mode = "TIMESTAMP"
        # startup.timestamp = ${STARTUP_TIMESTAMP}
    }
}
# transform {
#     JsonPath{
#         plugin_input = "mongocdc"
#         plugin_output = "parsed_cdc"

#         columns = [
#         {
#             "src_field" = "value"
#             "path" = "$.value._id._id._id.$oid"
#             "dest_field" = "_id"
#         },
#         {
#             "src_field" = "value"
#             "path" = "$.value.fullDocument"
#             "dest_field" = "fullDocument"
#         },
#         {
#             "src_field" = "value"
#             "path" = "$.value.documentKey._id.$oid"
#             "dest_field" = "documentKey"
#         },
#         {
#             "src_field" = "value"
#             "path" = "$.value.clusterTime.$timestamp.t"
#             "dest_field" = "loadTime"
#         },
#         {
#             "src_field" = "value"
#             "path"="$.value.operationType"
#             "dest_field" = "operationType"
#         }
#     ]
#     }
#     Sql{
#         plugin_input = "parsed_cdc"
#         plugin_output = "final_transform"
#         query = """
#         select 
#             _id as _id,
#             case 
#                 when operationType = 'insert' then 'I'
#                 when operationType = 'update' then 'U'
#                 when operationType = 'delete' then 'D'
#             END as aws_dms_operation,
#             fullDocument as _doc,
#             loadTime as load_time
#         from parsed_cdc
#         """
#     }
# }
sink {
    JDBC {
        driver = "com.mysql.cj.jdbc.Driver"
        url = "jdbc:mysql://mysql0:3306/stdb?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC&useUnicode=true&characterEncoding=UTF-8&rewriteBatchedStatements=true"
        username = "stuser"
        password = "stpw"

        plugin_input = "final_transform"
        generate_sink_sql = true
        table = "public.tasks_cdc"
        database = "stdb"
        primary_keys = ["_id"]
        schema_save_mode = "CREATE_SCHEMA_WHEN_NOT_EXIST"
        data_save_mode="APPEND_DATA"
    }
    # Console{
    #     parallelism = 1
    # }
}
